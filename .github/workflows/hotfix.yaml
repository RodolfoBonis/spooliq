name: Hotfix Workflow

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Hotfix version (leave empty for auto-patch)'
        required: false
        type: string
      description:
        description: 'Brief description of the hotfix'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  create-hotfix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Determine hotfix version
        id: determine-version
        run: |
          if [ -z "${{ inputs.version }}" ]; then
            echo "No version provided, auto-incrementing patch..."
            
            # Get current version from main branch
            if [ -f version.txt ]; then
              CURRENT_VERSION=$(cat version.txt | tr -d '\n' | tr -d ' ')
            else
              # Try to get from last tag
              LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
              CURRENT_VERSION=${LAST_TAG#v}
            fi
            
            echo "Current version: $CURRENT_VERSION"
            
            # Parse version and increment patch
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
            PATCH=$((PATCH + 1))
            
            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
            echo "Auto-incremented patch to: $NEW_VERSION"
          else
            NEW_VERSION="${{ inputs.version }}"
            echo "Using provided version: $NEW_VERSION"
          fi
          
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Create hotfix branch
        run: |
          HOTFIX_BRANCH="hotfix/v${{ steps.determine-version.outputs.version }}"
          git checkout -b $HOTFIX_BRANCH
          echo "HOTFIX_BRANCH=$HOTFIX_BRANCH" >> $GITHUB_ENV

      - name: Update version file
        run: |
          echo "${{ steps.determine-version.outputs.version }}" > version.txt
          git add version.txt
          git commit -m "chore: bump version to ${{ steps.determine-version.outputs.version }} for hotfix"

      - name: Create and push tag
        run: |
          TAG="v${{ steps.determine-version.outputs.version }}"

          echo "Creating hotfix tag $TAG..."
          git tag -a "$TAG" -m "Hotfix $TAG: ${{ inputs.description }}"

          echo "Pushing tag and branch..."
          git push origin ${{ env.HOTFIX_BRANCH }}
          git push origin "$TAG"

          echo "‚úì Hotfix tag $TAG created and pushed"
          echo "‚úì Branch ${{ env.HOTFIX_BRANCH }} pushed"

      - name: Ensure labels exist
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Create hotfix label if it doesn't exist
          gh label create "hotfix" \
            --description "Urgent fix for production issues" \
            --color "D93F0B" \
            --force 2>/dev/null || true

          # Create priority:critical label if it doesn't exist
          gh label create "priority:critical" \
            --description "Critical priority - requires immediate attention" \
            --color "B60205" \
            --force 2>/dev/null || true

          # Create automated label if it doesn't exist
          gh label create "automated" \
            --description "Automatically created by workflows" \
            --color "E99695" \
            --force 2>/dev/null || true

          # Create backport label if it doesn't exist
          gh label create "backport" \
            --description "Backport changes to other branches" \
            --color "FBCA04" \
            --force 2>/dev/null || true

          echo "‚úì Labels ensured"

      - name: Create Pull Request to main
        id: pr-main
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          PR_URL=$(gh pr create \
            --base main \
            --head ${{ env.HOTFIX_BRANCH }} \
            --title "üö® HOTFIX v${{ steps.determine-version.outputs.version }}: ${{ inputs.description }}" \
            --body "$(cat <<EOF
          ## üö® CRITICAL HOTFIX v${{ steps.determine-version.outputs.version }}

          ### Issue Description
          **${{ inputs.description }}**

          ### Hotfix Details
          - **Type:** CRITICAL - Production issue requiring immediate deployment
          - **Version:** v${{ steps.determine-version.outputs.version }} (patch increment)
          - **Tag:** ‚úì Already created and pushed
          - **Target:** Production (main branch)

          ### ‚è±Ô∏è Hotfix Timeline (URGENT - 1-2 hours)
          - [x] Hotfix branch created from main
          - [x] Version bumped (patch)
          - [x] Tag created
          - [ ] Code review & approval (ASAP!)
          - [ ] Merge to main
          - [ ] Production deployment (automatic)
          - [ ] Backport to develop (automatic)

          ### üìù Critical Checklist
          - [ ] Fix tested locally and verified
          - [ ] No breaking changes introduced
          - [ ] Critical issue FULLY resolved
          - [ ] No unintended side effects
          - [ ] Logs/metrics reviewed

          ### üîÑ Post-merge (Automatic)
          1. **Production deployment** via release.yaml
          2. **ArgoCD sync** to production cluster
          3. **Backport PR** to develop (auto-merge enabled)
          4. **GitHub Release** created
          5. **Team notification** via Telegram

          ### ‚ö†Ô∏è PRIORITY DEPLOYMENT
          This hotfix addresses a critical production issue.
          **Review and deploy IMMEDIATELY!**

          Tag \`v${{ steps.determine-version.outputs.version }}\` is already created.
          Deployment will trigger automatically on merge.

          ---
          *Critical hotfix - expedited review required*
          EOF
          )" \
            --label "hotfix" \
            --label "priority:critical" \
            --label "automated")
          
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "PR created: $PR_URL"

      - name: Notify n8n
        if: success()
        run: |
          curl -X POST "${{ secrets.N8N_WEBHOOK_URL }}" \
            -H "Authorization: Bearer ${{ secrets.N8N_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "event_type": "hotfix_created",
              "repository": "${{ github.repository }}",
              "version": "v${{ steps.determine-version.outputs.version }}",
              "branch": "${{ env.HOTFIX_BRANCH }}",
              "actor": "${{ github.actor }}",
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'",
              "details": {
                "description": "${{ inputs.description }}",
                "pr_url": "${{ steps.pr-main.outputs.pr_url }}",
                "priority": "critical",
                "tag_created": true,
                "urgent": true
              },
              "telegram_chat_id": "${{ secrets.CHAT_ID }}",
              "telegram_thread_id": "${{ secrets.THREAD_ID }}",
              "telegram_message": "üö® HOTFIX v${{ steps.determine-version.outputs.version }} created!\n\n${{ inputs.description }}\n\n‚ö†Ô∏è CRITICAL - Review ASAP\nüìã PR: ${{ steps.pr-main.outputs.pr_url }}"
            }' || echo "Notification failed (non-critical)"