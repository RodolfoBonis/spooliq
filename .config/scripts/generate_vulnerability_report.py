import os
import openai
from github import Github
from github import Auth


OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
GITHUB_TOKEN = os.getenv("GITHUB_TOKEN")
REPO_NAME = os.getenv("REPO_NAME")
PR_NUMBER = os.getenv("PR_NUMBER")

openai.api_key = OPENAI_API_KEY

with open('vulnerabilities.txt', 'r') as file:
    vulnerabilities = file.read()

prompt = f"""
You are a senior software engineer reviewing a pull request. A security check (govulncheck) has identified the following vulnerabilities. For each vulnerability, provide a detailed summary suitable for a pull request comment, written in a clear and concise technical style.  Each summary should include:
  
            * **Vulnerability Description:** A comprehensive explanation of the vulnerability, its potential impact, and how it could be exploited.  Use precise technical terminology and avoid jargon where possible.
            * **Vulnerability ID:** The unique identifier for the vulnerability (e.g., GO-XXXX-YYYY).
            * **Affected Package and Version:** The name and version of the affected package.
            * **Fixed Version:** The version of the package that addresses the vulnerability (if available).  If not available, state that a fix is not yet released.
            * **Remediation Advice:** Specific steps to remediate the vulnerability.  Include recommendations for updating dependencies, using alternative packages, or implementing workarounds if necessary.
            * **Show step by step how to fix the vulnerability, may include commands to run, etc..
          
              The Vulnerabilities are:
                {vulnerabilities}
                
                
              Format your response as a numbered markdown list. Each vulnerability should be a separate list item.
"""

response = openai.chat.completions.create(
    model="gpt-4o-mini",
    messages=[
        {"role": "system", "content": prompt},
    ],
)

detailed_report = response.choices[0].message.content.strip()

auth = Auth.Token(GITHUB_TOKEN)

git = Github(auth=auth)

repo = git.get_repo(REPO_NAME)
pull_request = repo.get_pull(int(PR_NUMBER))

comment_body = f"### Vulnerabilities found by govulncheck\n\n{detailed_report}\n\n**Suggested Fixes:**\n\n- Analyze the reported vulnerabilities and update the affected dependencies to their latest versions.\n- If a fix is not available, consider using alternative packages or implementing a workaround.\n- Refer to the official documentation or security advisories for more details on how to mitigate these vulnerabilities."

pull_request.create_issue_comment(comment_body)